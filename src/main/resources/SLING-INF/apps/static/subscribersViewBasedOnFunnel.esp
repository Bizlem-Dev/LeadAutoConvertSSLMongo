<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>New Tamplate</title>
	<!--
	<link rel="stylesheet"
		href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
		integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
		crossorigin="anonymous">
	<script
		src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
		integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuW  VxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
		crossorigin="anonymous"></script>
	<script
		src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
	<script
		src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"
		type="text/javascript"></script>
	
	<script type="text/javascript"
		src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
	<script type="text/javascript"
		src="https://cdn.datatables.net/1.10.16/js/dataTables.bootstrap.min.js"></script>
		
	<script type="text/javascript"
		src="<%=request.getContextPath()%>/apps/LeadConverterNewUIJs/jquery-ui-1.10.4.min.js"></script>
		
	<link rel="stylesheet"
		href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
	
	<script type="text/javascript"
		src="<%=request.getContextPath()%>/apps/LeadConverterNewUIJs/javascript.js"></script>
	<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
	
	-->
	
	<link rel="stylesheet" type="text/css" href="<%=request.getContextPath()%>/apps/LeadConverterReportCSS/bootstrap.css">
	<link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
	<link rel="stylesheet" type="text/css" href="<%=request.getContextPath()%>/apps/LeadConverterReportCSS/custom.css">
	<link href="https://fonts.googleapis.com/css?family=Roboto+Condensed" rel="stylesheet">
	<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="<%=request.getContextPath()%>/apps/LeadConverterReportJS/bootstrap.js"></script>
	<script src="<%=request.getContextPath()%>/apps/LeadConverterReportJS/custom.js"></script>
</head>
<body>
	<section class="container-fluid main-head-section">
		<div class="container">
			<div class="row">
				<div class="col-md-3 left-head-logo">
					<h1>Logo</h1>
				</div>
				<div class="col-md-9 right-head-detail">
					
				</div>
			</div>
		</div>
	</section>
	<section class="container-fluid main-menubar-secion p-0">
		<div id="menu_area" class="menu-area">
		    <div class="container">
		        <div class="row">
		            <nav class="navbar navbar-light navbar-expand-lg mainmenu">
		                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
		                <span class="navbar-toggler-icon"></span>
		                </button>
		                <div class="collapse navbar-collapse" id="navbarSupportedContent">
		                    <ul class="navbar-nav mr-auto">
		                        <li class="dropdown">
		                            <a class="dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Funnel</a>
		                            <ul class="dropdown-menu" aria-labelledby="navbarDropdown" id="funnelSelect">
		                            
		                            </ul>
		                        </li>
		                        <li class="dropdown">
	                               <a class="dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Sub Funnel</a>
		                            <ul class="dropdown-menu" aria-labelledby="navbarDropdown" id="subFunnelSelect">
			                            <li><a href="#" class="">Show All</a></li>
			                            <li><a href="#">Option 2</a></li>
			                            <li><a href="#">Option 3</a></li>
		                            </ul>
		                        </li>
								<li style="margin-top:12px">
		                            <label for="female">Start date : </label>
									<input type="text" value="24 Oct 2018 07:44" name="start_date" id="start_date">
		                        </li>
								<li style="margin-top:12px;margin-left:4px">
		                            <label for="female">Start date : </label>
									<input type="text" value="24 Oct 2018 07:44" name="end_date" id="end_date">
		                        </li>
		                    </ul>
		                   
		                </div>
		                <input style="margin-top:6px;float-right:0px" value="search" type="text" name="search_txt" id="search_txt"></input>
		            </nav>
		        </div>
		    </div>
		</div>
	</section>
	<p id='msg' style='margin-left:120px'></p>
	<section class="container table-section mt-5" style="display: none;">
		<div class="row">
			<div class="col-md-12">
				<table class="table table-striped border">
				     <!-- 
					 <thead>
					      <tr>
					        <th>Funnel ID</th>
					        <th>Sub Funnel Name</th>
					        <th>Campaign ID</th>
					        <th>Campaign Name</th>
					        <th>Subscribers</th>
						  </tr>
					  </thead>
					  -->
				    <thead id='funnel_thead'></thead> 
				    <tbody id='funnel_tbody'></tbody>
				  </table>
			</div>
		</div>
	</section>
	<script type="text/javascript">
		$('.option').click(function(){
		    $('.table-section').slideDown();
		});
	</script>
	
<script>
	
	$( document).ready(function() {
		var remoteuser ='<%=request.getRemoteUser()%>';
	    //alert("remoteuser : "+remoteuser);
		$.ajax({
	        type : 'GET',
	        url :'<%=request.getContextPath()%>/servlet/service/CampaignReportApi.funnelList',
	        data: {
	    	      remoteuser : remoteuser,
	             },
			success: function (dataa) {
					//alert	("CampaignReportApi.funnelList : "+dataa);
					var JsonArray = JSON.parse(dataa);
					var optionMap = "";
					
					for(var i=0;i<JsonArray.length;i++){
						 optionMap = optionMap + "<li><a href='#' onclick='showSubFunnel(this.id)' id='"+JsonArray[i]+"'>"+JsonArray[i]+"</a></li>";
					}
					document.getElementById("funnelSelect").innerHTML  =optionMap;
				}
	        });	
	});
	
	function showSubFunnel(funnelId){
	
	var remoteuser ='<%=request.getRemoteUser()%>';
		var funnel_thead = "<tr><th>Unsubscribers</th>";
		var funnel_thead_new = "<tr><th rowspan='2'>Subscribers</th><th colspan='3'>Unsubscribers</th>";
		var funnel_thead_new2="<th>CampaignId</th><th>Clicks</th><th>Url</th>";
		//<tr><th rowspan="2">Subscribers</th><th colspan="3">Unsubscribers</th><th colspan="3">Unknown</th><th colspan="3">Explore</th></tr>
		//<tr><th>OR</th><th>CR</th><th>Click</th></tr>
		var subFunnelJsonArray;
		$.ajax({
	        type : 'GET',
	        url :'<%=request.getContextPath()%>/servlet/service/CampaignReportApi.subFunnelList',
	        data: {
	    	      remoteuser : remoteuser,
	    	      funnel_id : funnelId
	             },
			success: function (dataa) {
			        //alert('funnelId : '+funnelId);
					subFunnelJsonArray = JSON.parse(dataa);
					//alert	("subFunnelJsonArray : "+subFunnelJsonArray);
					var subFunnelOptionMap = "<li><a href='#' onclick='showFunnelDataTest(this.id,"+funnelId+")' id='showall'>Show All</a></li>";
					for(var i=0;i<subFunnelJsonArray.length;i++){
					   //funnel_thead=funnel_thead+"<th><a href='<%=request.getContextPath()%>/servlet/service/CampaignReportApi.campaignView?subfunnel_name="+subFunnelJsonArray[i]+"&funnel_name="+funnelId+"' target='_blank'>"+subFunnelJsonArray[i]+"</th>";
					   
					   //subFunnelOptionMap = subFunnelOptionMap + "<li><a href='#'>"+subFunnelJsonArray[i]+"</a></li>";
					   subFunnelOptionMap = subFunnelOptionMap + "<li><a href='#' onclick='showFunnelDataTest(this.id,"+funnelId+")' id='"+subFunnelJsonArray[i]+"'>"+subFunnelJsonArray[i]+"</a></li>";
					   
					   funnel_thead_new=funnel_thead_new+"<th colspan='3'>"+subFunnelJsonArray[i]+"</th>";
					   funnel_thead_new2=funnel_thead_new2+"<th>CampaignId</th><th>Clicks</th><th>Url</th>";
					}
					funnel_thead=funnel_thead+"</tr>";
					funnel_thead_new=funnel_thead_new+"</tr>"+"<tr>"+funnel_thead_new2+"</tr>";
					//alert	("funnel_thead_new : "+funnel_thead_new);
					//alert("subFunnelOptionMap : "+subFunnelOptionMap);
					document.getElementById("subFunnelSelect").innerHTML  =subFunnelOptionMap;
					//alert	("funnel_thead : "+funnel_thead);
					//document.getElementById("funnelSelect").innerHTML  =optionMap;
					
				}
	        });
	
	}
	
	function showFunnelDataTest(subfunnelId,funnelId){
	
	  alert('You Have Selected : '+subfunnelId);
	  var remoteuser ='akhilesh';
	  var start_date=document.getElementById("start_date").value;
	  var end_date=document.getElementById("end_date").value;
	  alert('start_date : '+start_date+' end_date : '+end_date);
	  if(start_date=='' || end_date==''){
	    alert('Date Should not be Blank : ');
		$('.table-section').slideUp();
		return;
	  }else{
		  
		  $.ajax({
		        type : 'GET',
		        url :'<%=request.getContextPath()%>/servlet/service/CampaignReportApi.subscribersViewBasedOnFunnelData',
		        data: {
		    	      remoteuser : remoteuser,
		    	      funnel_id : funnelId,
					  sub_funnel_name : subfunnelId,
		             },
				success: function (dataa) {
		            	var campaignJsonArray = JSON.parse(dataa);
						alert(campaignJsonArray.length);
						alert(campaignJsonArray.length==0);
						if(campaignJsonArray.length==0){
						alert('Slide Up');
						    document.getElementById("msg").innerHTML  ="<h3><b style='color:red'>No Records Found</h3></b>";
					      	$('.table-section').slideUp();
							return;
						}
						//console.log(dataa);
						//alert	("campaignJsonArray : "+campaignJsonArray.length);
						//alert	("campaignJsonArray : "+campaignJsonArray);
						var campaignRow = "<tr><td><a href='#' target='_blank'>Campaign</a></td>";
						var subscriberRow = "<tr><td><a href='#' target='_blank'>Subscribers</a></td>";
						var finalRow = "";
						var campSubFinalRow= "";
						var subfunnel_thead_new = "<tr><th rowspan='2'>Subscribers</th><th colspan='3'>Unsubscribers</th>";
			            var subfunnel_thead_new2="<th>CampaignId</th><th>Clicks</th><th>Url</th>";
						for(var i=0;i<campaignJsonArray.length;i++){
							var campaignJsonObject=campaignJsonArray[i];
							//alert("campaignJsonObject : "+campaignJsonObject.subscriber_email);
							console.log(campaignJsonObject.subscriber_email);
							//alert("subfunnel_list : "+campaignJsonObject.subfunnel_list);
							var subfunnel_list=campaignJsonObject.subfunnel_list;
							if(i==0){
								for(var a=0;a<subfunnel_list.length;a++){
									  var subFunnelName=subfunnel_list[a];
									  subfunnel_thead_new=subfunnel_thead_new+"<th colspan='3'>"+subFunnelName+"</th>";
									  subfunnel_thead_new2=subfunnel_thead_new2+"<th>CampaignId</th><th>Clicks</th><th>Url</th>";
								}
								
								subfunnel_thead_new=subfunnel_thead_new+"</tr>"+"<tr>"+subfunnel_thead_new2+"</tr>";
							}
							var subfunnel_list_size=subfunnel_list.length;
							
							//var data = [];
							//data.push(feed);
							for(var j=0;j<subfunnel_list.length;j++){
							      //alert(subfunnel_list[j]);
								  var subFunnelName=subfunnel_list[j];
								  console.log('subFunnelName : '+subFunnelName);
								  var subfunnel_json_arr=campaignJsonObject[subFunnelName];
								  var campaignBlankTr="<td></td><td></td><td></td></tr>";
								  var subfunnel_list_size_left=j;
								  var subfunnel_list_size_right=subfunnel_list_size-(j+1);
								  //alert("subfunnel_list_size : "+subfunnel_list_size+" subfunnel_list_size_left : "+subfunnel_list_size_left+" subfunnel_list_size_right : "+subfunnel_list_size_right);
								  for(var k=0;k<subfunnel_json_arr.length;k++){
								        var subFunnelCampaignJsonObj=subfunnel_json_arr[k];
										console.log(JSON.stringify(subFunnelCampaignJsonObj));
										var funnelNodeName=subFunnelCampaignJsonObj.funnelNodeName;
										var subFunnelNodeName=subFunnelCampaignJsonObj.subFunnelNodeName;
										var subscriber_email=subFunnelCampaignJsonObj.subscriber_email;
										var subscriber_userid=subFunnelCampaignJsonObj.subscriber_userid;
										var campaign_id=subFunnelCampaignJsonObj.campaign_id;
										var urlclickstatistics_url=subFunnelCampaignJsonObj.urlclickstatistics_url;
										var Sling_Subject=subFunnelCampaignJsonObj.Sling_Subject;
										var clicks=subFunnelCampaignJsonObj.clicks;
										var viewed=subFunnelCampaignJsonObj.viewed;
										var open_rate=subFunnelCampaignJsonObj.open_rate;
										var click_rate=subFunnelCampaignJsonObj.click_rate;
									    var campaignInnerBlankTrleft="";
										var campaignInnerBlankTrRight="";
										
										for(var m=0;m<subfunnel_list_size_left;m++){
										    campaignInnerBlankTrleft=campaignInnerBlankTrleft+"<td></td><td></td><td></td>";
										}
										for(var n=0;n<subfunnel_list_size_right;n++){
										    campaignInnerBlankTrRight=campaignInnerBlankTrRight+"<td></td><td></td><td></td>";
										}
										/*
										if(k==0){
										var campaignTr="<tr><td rowspan='"+subfunnel_json_arr.length+"'>"+subscriber_email+"</td><td></td><td></td><td></td>"+campaignInnerBlankTrleft+"<td>"+campaign_id+"</td><td>"+clicks+"</td><td>"+urlclickstatistics_url+"</td>"+campaignInnerBlankTrRight+"</tr>";
										campSubFinalRow=campSubFinalRow+campaignTr;
										}else{
										var campaignTr="<tr><td></td><td></td><td></td>"+campaignInnerBlankTrleft+"<td>"+campaign_id+"</td><td>"+clicks+"</td><td>"+urlclickstatistics_url+"</td>"+campaignInnerBlankTrRight+"</tr>";
										campSubFinalRow=campSubFinalRow+campaignTr;
										}
										*/
										if(k==0){
											var campaignTr="<tr><td rowspan='"+subfunnel_json_arr.length+"'>"+subscriber_email+"</td><td></td><td></td><td></td>"+campaignInnerBlankTrleft+"<td><a href='<%=request.getContextPath()%>/servlet/service/CampaignReportApi.campaignView?campaign_id="+campaign_id+"' target='_blank'>"+campaign_id+"</a></td><td><a href='<%=request.getContextPath()%>/servlet/service/CampaignReportApi.ucsSubscriberClickStatistics?campaign_id="+campaign_id+"' target='_blank'>"+clicks+"</a></td><td><a href='<%=request.getContextPath()%>/servlet/service/CampaignReportApi.ucsUrlClickStatistics?campaign_id="+campaign_id+"&url="+urlclickstatistics_url+"&userid="+subscriber_userid+"' target='_blank'>"+urlclickstatistics_url+"</a></td>"+campaignInnerBlankTrRight+"</tr>";
											campSubFinalRow=campSubFinalRow+campaignTr;
											}else{
											var campaignTr="<tr><td></td><td></td><td></td>"+campaignInnerBlankTrleft+"<td><a href='<%=request.getContextPath()%>/servlet/service/CampaignReportApi.campaignView?campaign_id="+campaign_id+"' target='_blank'>"+campaign_id+"</a></td><td><a href='<%=request.getContextPath()%>/servlet/service/CampaignReportApi.ucsSubscriberClickStatistics?campaign_id="+campaign_id+"' target='_blank'>"+clicks+"</a></td><td><a href='<%=request.getContextPath()%>/servlet/service/CampaignReportApi.ucsUrlClickStatistics?campaign_id="+campaign_id+"&url="+urlclickstatistics_url+"&userid="+subscriber_userid+"' target='_blank'>"+urlclickstatistics_url+"</a></td>"+campaignInnerBlankTrRight+"</tr>";
											campSubFinalRow=campSubFinalRow+campaignTr;
											}
										//alert('campaignTr : '+campaignTr);
										
								  }
								  
								  //alert(campaignTr);
							}
							//var campaignJsonObject=JSON.parse(campaignJsonArray[i].subfunnel_list);
						}
						//alert(campSubFinalRow);
						document.getElementById("msg").innerHTML  ="<h3><b style='color:green'>Records Found</h3></b>";
						document.getElementById("funnel_thead").innerHTML  =subfunnel_thead_new;
						document.getElementById("funnel_tbody").innerHTML  =campSubFinalRow;
						$('.table-section').slideDown();
						
					}
		        });
			}
	}
	
	
	</script>
	
	<link rel="stylesheet"
		href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<script type="text/javascript"
		src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
	<script
		src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.17.1/moment.min.js"></script>
	<link rel="stylesheet"
		href="https://rawgit.com/Eonasdan/bootstrap-datetimepicker/master/build/css/bootstrap-datetimepicker.min.css">
	<script src="https://rawgit.com/Eonasdan/bootstrap-datetimepicker/master/build/js/bootstrap-datetimepicker.min.js"></script>

</body>
</html>